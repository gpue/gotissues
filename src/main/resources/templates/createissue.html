<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="skeleton::head"></head>
<body>
	<div th:replace="skeleton::jumbotron"></div>
	<div th:replace="skeleton::nav"></div>
	<div th:replace="skeleton::shout"></div>
	<div class="container col-md-7 col-md-offset-2">
		<form class="form-horizontal" role="form" action="issuelist"
			method="post" data-parsley-validate="true" id="issueform">
			<div th:if="${parent} != null" class="form-group">
				<label for="parent" class="col-sm-2 control-label">Parent</label> <input
					type="hidden" id="parent" name="parent" th:value="${parent.id}" />
				<div class="col-sm-10">
					<input type="text" class="form-control"
						th:attrappend="value=${'#' + parent.id + ' ' + parent.title}"
						disabled="disabled" />
				</div>
			</div>
			<div class="form-group">
				<label for="title" class="col-sm-2 control-label">Title</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" id="title" name="title"
						placeholder="My New Issue" required="required"
						data-parsley-length="[3,64]" />
				</div>
			</div>
			<div class="form-group">
				<label for="assignees[]" class="col-sm-2 control-label">Assignees</label>
				<div class="col-sm-10">
					<select id="select-beast" name="assignees[]" multiple="multiple">
						<option th:value="${me.name}" th:text="${me.name}">Add a
							contributor...</option>
						<option th:each="contributor : ${contributors}"
							th:if="${contributor.name} != ${me.name}"
							th:text="${contributor.name}" th:value="${contributor.name}">Add
							a contributor...</option>
					</select>
				</div>
			</div>
			<div class="form-group">
				<label for="deadline" class="col-sm-2 control-label">Deadline</label>
				<div class="col-sm-10">
					<input class="datepicker form-control"
						data-date-format="dd.mm.yyyy" id="deadline" name="deadline"></input>
				</div>
			</div>
			<div class="form-group">
				<label for="description" class="col-sm-2 control-label">Description</label>
				<div class="col-sm-10">
					<div id="sndesc"></div>

				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<button type="button" onclick="javascript:addIssue()" class="btn btn-primary fa fa-save">&nbsp;Create</button>
				</div>
			</div>
		</form>
	</div>
	<script type="text/javascript" th:inline="javascript">
		$(document).ready(function() {
			$('#sndesc').summernote({
				height : 150
			});
			$('#select-beast').selectize({
				create : true,
				sortField : 'text'
			});
			$('.datepicker').datepicker({
				startDate : '-0d',
				weekStart : 1,
				todayHighlight : true,
				todayBtn : true,
				autoclose : true
			});
		});

		function addIssue() {
			if ($('#issueform').parsley().validate()) {

				var formData = {
					title : document.getElementById("title").value,
					description : $('#sndesc').code(),
					deadline : document.getElementById("deadline").value,
					assignees : $("#select-beast").val()
				};

				if (document.getElementById("parent") != null)
					formData.parent = document.getElementById("parent").value;
				if (document.getElementById("deadline").length != 0)
					formData.deadline = document.getElementById("deadline").value;

				$.ajax({
					type : "GET",
					url : "/api/issues:add",
					data : formData,
					success : function(data) {
						window.location.href = '/issue/' + data.id;
					},
					error : function(){
						shout("danger","Error!","Issue was not created due to an error.");
					},
					dataType : "json",
					contentType : "application/json"
				});
			}
		}
	</script>
</body>
</html>